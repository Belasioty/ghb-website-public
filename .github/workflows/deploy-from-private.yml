name: Build & Deploy (from private repo)

on:
  workflow_dispatch: {}

permissions:
  contents: write  # needed for pushing gh-pages

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout this (public) repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
            fetch-depth: 0

      - name: Checkout private source repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          repository: belasioty/ghb-website
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: private-src

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: '20'

      - name: Install deps & build (Vite)
        working-directory: private-src
        env:
          # Optional: if you need absolute asset paths for custom domain
          # Set base in vite.config instead if preferred (base: '/')
          PUBLIC_URL: https://ghb-emea.com/
        run: |
          npm ci
          npm run build
          echo "---- dist (vite) ----"
          ls -la dist

      - name: Prepare deploy folder
        run: |
          rm -rf dist_publish
          mkdir -p dist_publish/.well-known
          # COPY FROM VITE OUTPUT (dist)
          cp -R private-src/dist/* dist_publish/
          # SPA deep link fallback
          cp private-src/dist/index.html dist_publish/404.html || true
          # Let GitHub Pages serve dotfolders
          touch dist_publish/.nojekyll
          # Custom domain
          echo "ghb-emea.com" > dist_publish/CNAME
          # Microsoft verification file (or put it in private/public/.well-known/)
          cat > dist_publish/.well-known/microsoft-identity-association.json <<'JSON'
          {
            "associatedApplications": [
              { "applicationId": "234ade1d-7921-43a8-829f-18f533294454" }
            ]
          }
          JSON
          echo "---- dist_publish root ----"; ls -la dist_publish | sed -n '1,200p'
          echo "---- .well-known ----"; ls -la dist_publish/.well-known | sed -n '1,200p'

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e  # v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: dist_publish
          force_orphan: true
          commit_message: "deploy: ${{ github.sha }}"

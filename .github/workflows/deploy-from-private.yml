name: Build & Deploy (from private repo)

on:
  workflow_dispatch: {}

permissions:
  contents: write  # allow pushing

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this (public) repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          fetch-depth: 0

      - name: Checkout private source repo
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4.3.0
        with:
          repository: belasioty/ghb-website
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: private-src

      - name: Setup Node
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: '20'

      - name: Install deps & build (Vite)
        working-directory: private-src
        env:
          PUBLIC_URL: https://ghb-emea.com/
        run: |
          npm ci
          npm run build
          echo "---- dist (vite) ----"
          ls -la dist

      - name: Prepare deploy folder
        run: |
          rm -rf dist_publish
          mkdir -p dist_publish/.well-known
          cp -R private-src/dist/* dist_publish/
          cp private-src/dist/index.html dist_publish/404.html || true
          touch dist_publish/.nojekyll
          echo "ghb-emea.com" > dist_publish/CNAME
          cat > dist_publish/.well-known/microsoft-identity-association.json <<'JSON'
          {
            "associatedApplications": [
              { "applicationId": "234ade1d-7921-43a8-829f-18f533294454" }
            ]
          }
          JSON
          echo "---- dist_publish ----"; ls -la dist_publish

      - name: Publish to gh-pages (manual push)
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd dist_publish
          git init
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "deploy: ${GITHUB_SHA}"
          # Force create/update gh-pages as an orphan
          git branch -M gh-pages
          git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git push -f origin gh-pages
